<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Map Crop Example (Satellite + Street Toggle)</title>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; width: 100%; margin-bottom: 20px; }
    #resultBox { 
      border: 2px dashed #555; 
      padding: 10px; 
      width: 400px; 
      min-height: 200px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: #f9f9f9;
    }
    #resultBox img { max-width: 100%; }
  </style>
</head>
<body>
  <h2>Crop the Map</h2>
  <p>Draw a rectangle on the map. You can toggle between Satellite and Street view. Cropped result will show below.</p>
  
  <div id="map"></div>
  <div id="resultBox">Cropped map will appear here</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <script>
    // Init map
    const map = L.map('map').setView([6.912985845514279, 122.06318537962856], 17);

    // ✅ Street View (OpenStreetMap)
    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      crossOrigin: 'anonymous'
    });

    // ✅ Satellite View (Esri)
    const satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; <a href="https://www.esri.com/">Esri</a>, ' +
        'Sources: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, ' +
        'UPR-EGP, and the GIS User Community'
    });

    // Add default layer
    streetLayer.addTo(map);

    // ✅ Layer control (toggle between street & satellite)
    L.control.layers({
      "Street Map": streetLayer,
      "Satellite": satelliteLayer
    }).addTo(map);

    // Add drawing tools (rectangle only)
    const drawControl = new L.Control.Draw({
      draw: {
        polygon: false,
        marker: false,
        circle: false,
        polyline: false,
        circlemarker: false,
        rectangle: {
          shapeOptions: { color: 'red' }
        }
      }
    });
    map.addControl(drawControl);

    // When a rectangle is drawn
    map.on(L.Draw.Event.CREATED, (e) => {
      const layer = e.layer;
      map.addLayer(layer);

      // Get bounds of rectangle
      const bounds = layer.getBounds();

      // Convert full map to canvas
      leafletImage(map, function(err, canvas) {
        if (err) { console.error(err); return; }

        // Get pixel coords of bounds
        const nw = map.latLngToContainerPoint(bounds.getNorthWest());
        const se = map.latLngToContainerPoint(bounds.getSouthEast());

        const x = nw.x;
        const y = nw.y;
        const width = se.x - nw.x;
        const height = se.y - nw.y;

        // Create a cropped canvas
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = width;
        croppedCanvas.height = height;
        const ctx = croppedCanvas.getContext('2d');
        ctx.drawImage(canvas, x, y, width, height, 0, 0, width, height);

        // Show result in box
        const img = document.createElement('img');
        img.src = croppedCanvas.toDataURL();
        const resultBox = document.getElementById('resultBox');
        resultBox.innerHTML = "";
        resultBox.appendChild(img);
      });
    });
  </script>
</body>
</html>
