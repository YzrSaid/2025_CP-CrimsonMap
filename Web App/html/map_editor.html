<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Main</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/styles/map_editor.css">

</head>
<body>
<div class="container">
    <!-- Sidebar -->
    <div class="left">
        <div class="logo">
            <img src="/assets/imgs/CrimsonMap Logo 1.png" alt="CrimsonMap Logo">
        </div>
        <div class="time">11:11:05 PM | 12-12-25</div>
        <div class="welcome">WELCOME, <span>ADMIN!</span></div> 

        <div class="sidebar"> 
            <ul> 
                <li>
                    <a href="/html/dashboard_main.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="/html/buildings.html">
                        <i class="fas fa-building"></i> Manage Buildings
                    </a>
                </li> 
                <li class="active">
                    <a href="/html/map_editor.html">
                        <i class="fas fa-map"></i> Map Editor
                    </a>
                </li> 
                <li>
                    <a href="/html/recent_activity.html">
                        <i class="fas fa-history"></i> Recent Activity
                    </a>
                </li> 
                <li>
                    <a href="/html/reports.html">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li> 
                <li>
                    <a href="/html/account.html">
                        <i class="fas fa-user-cog"></i> Account
                    </a>
                </li> 
            </ul> 
        </div>
        

    </div>


    <!-- Main Content -->
    <div class="right">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <div class="menu-icon">&#9776;</div>
                <div class="topbar-title">CrimsonMap | WMSU</div>
            </div>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <h2>Map Editor</h2>
            <span>Main / Map Editor</span>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <div class="topmap">
                <div class="top-title_sort">
                    <div class="title">
                        <h2>Map Overview</h2>
                        <button id="migrateNodesBtn" style="display:block;">Migrate Nodes</button>

                    </div>

                    <div class="sorting">
                        <select>
                            <option>Main Map</option>
                        </select>
                    </div>
                </div>

                <div class="bottom-map">
                    <div id="map-overview" class="map-overview"></div>
                </div>

                <div id="mapModal" class="map-modal">
                    <div class="map-modal-content">
                        <span class="close-btn">&times;</span>

                        <!-- Left sidebar -->
                        <div class="map-sidebar">
                            <h3>Details</h3>
                            <p>Select a building or barrier to see details here.</p>
                        </div>

                        <!-- Map area -->
                        <div class="map-area">
                            <div id="map-full"></div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="bottomen">
                <div class="top-tabs">
                    <button class="tab active">Nodes</button>
                    <button class="tab">Edges</button>
                </div>

                <div class="mid-sea_sort_add">
                    <div class="midleft">
                        <div class="search">
                            <input type="text" placeholder="Search...">
                            <i class="fas fa-search"></i>
                        </div>

                        <div class="sorter">
                            <select>
                                <option>Sort</option>
                            </select>
                        </div>
                        
                    </div>

                    <div class="midright">
                        <div class="addnode">
                            <button class="add-btn">Add Node</button>
                        </div>
                    </div>
                </div>

                <div class="bottom-tbl">
                    <div class="nodetbl scroll-x">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name/Label</th>
                                    <th>Type</th>
                                    <th>Coordinates (lat, lng)</th>
                                    <th>Related Infrastructure</th>
                                    <th>Related Room</th>
                                    <th>Indoor/Outdoor</th>
                                    <th>Campus</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS will populate rows here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="edgetbl scroll-x" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>From & To Node</th>
                                    <th>Distance (m)</th>
                                    <th>Path Type</th>
                                    <th>Elevation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS will populate rows here -->
                            </tbody>
                        </table>    
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Add Node Modal Overlay -->
<div id="addNodeModal" class="modal-overlay" style="display:none;">
    <div class="modal">
        <h2>Add Node</h2>
        <form id="nodeForm">
            <!-- Node Name/Label + Node ID -->
            <div class="form-row">
                <div class="form-group">
                    <label>Node Name/Label</label>
                    <input id="nodeName" type="text" placeholder="eg. College of Nursing" required>
                </div>
                <div class="form-group">
                    <label>Node ID</label>
                    <input id="nodeId" type="text" disabled>
                </div>
            </div>

            <!-- Type Dropdown/Input -->
            <div class="form-group">
                <label>Type</label>
                <select id="nodeType">
                    <option value="">Select type</option>
                    <option value="room">Room</option>
                    <option value="barrier">Barrier</option>
                    <option value="infrastructure">Infrastructure</option>
                </select>
            </div>

            <!-- Related Infrastructure -->
            <div class="form-group">
                <label>Related Infrastructure</label>
                <select id="relatedInfra">
                    <option value="">Select infrastructure</option>
                </select>
            </div>

            <!-- Related Room -->
            <div class="form-group">
                <label>Related Room</label>
                <select id="relatedRoom">
                    <option value="">Select room</option>
                </select>
            </div>

            <!-- Coordinates -->
            <div class="form-group">
                <label>Coordinates</label>
                <div class="form-row">
                    <div class="form-group">
                        <input id="latitude" type="text" placeholder="Latitude">
                    </div>
                    <div class="form-group">
                        <input id="longitude" type="text" placeholder="Longitude">
                    </div>
                </div>
            </div>

            <!-- Indoor/Outdoor -->
            <div class="form-group checkbox-row">
                <label>Indoor</label>
                <input type="checkbox" id="indoorCheckbox">
                <label style="margin-left:20px;">Outdoor</label>
                <input type="checkbox" id="outdoorCheckbox">
            </div>

            <!-- Indoor Details (hidden by default, shown if Indoor checked) -->
            <div id="indoorDetails" style="display:none;">
                <div class="form-group">
                    <label>Floor</label>
                    <input id="floor" type="text" placeholder="e.g. 2">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>X Coordinate</label>
                        <input id="xCoord" type="text" placeholder="X">
                    </div>
                    <div class="form-group">
                        <label>Y Coordinate</label>
                        <input id="yCoord" type="text" placeholder="Y">
                    </div>
                </div>
            </div>

            <!-- Campus Dropdown -->
            <div class="form-group">
                <label>Campus</label>
                <select id="campusDropdown">
                    <option value="">Select campus</option>
                </select>
            </div>

            <!-- Actions -->
            <div class="modal-actions">
                <button type="submit" class="save-btn">Save</button>
                <button type="button" class="cancel-btn" onclick="closeNodeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>






<!-- Add Edge Modal Overlay -->
<div id="addEdgeModal" class="modal-overlay" style="display:none;">
    <div class="modal">
        <h2>Add Edge</h2>

        <form>
            <!-- Edge ID -->
            <div class="form-group"> 
                <label>Edge ID</label> 
                <input type="text" value="EDG-003" disabled> 
            </div>

            <!-- Start & End Node -->
            <div class="form-row">
                <div class="form-group">
                    <label>Start Node</label>
                    <select id="startNode">
                        <option value="">Select start node</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>End Node</label>
                    <select id="endNode">
                        <option value="">Select end node</option>
                    </select>
                </div>
            </div>


            <!-- Additional Information -->
            <h3>Additional Information:</h3>
            <div class="form-group checkbox-row">
                <label>Bidirectional Path</label>
                <input type="checkbox">
            </div>

            <!-- Path Type & Elevation -->
            <div class="form-row">
                <div class="form-group">
                    <label>Path Type</label>
                    <select id="pathType">
                        <option value="">Select path type</option>
                        <option value="via_gate">Via Gate</option>
                        <option value="via_overpass">Via Overpass</option>
                        <option value="walkway">Walkway</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Elevation</label>
                    <select id="elevation">
                        <option value="">Select elevation</option>
                        <option value="flat">Flat</option>
                        <option value="slope_up">Slope (Up)</option>
                        <option value="slope_down">Slope (Down)</option>
                        <option value="stairs">Stairs</option>
                        <option value="steep_up">Steep (Up)</option>
                        <option value="steep_down">Steep (Down)</option>
                        <option value="mixed">Mixed</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Actions --> 
            <div class="modal-actions"> 
                <button type="submit" class="save-btn">Save</button> 
                <button type="button" class="cancel-btn">Cancel</button> 
            </div> 
        </form> 
    </div> 
</div>










<!-- Edit Node Modal Overlay -->
<div id="editNodeModal" class="modal-overlay" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editNodeTitle">
    <h2 id="editNodeTitle">Edit Node</h2>

    <form id="editNodeForm" novalidate>
        <!-- Node Name/Label + Node ID -->
        <div class="form-row">
            <div class="form-group">
                <label for="editNodeName">Node Name/Label</label>
                <input id="editNodeName" name="nodeName" type="text" required>
            </div>
            <div class="form-group">
                <label for="editNodeId">Node ID</label>
                <input id="editNodeId" name="nodeId_display" type="text" readonly disabled>
                <input id="editNodeIdHidden" name="nodeId" type="hidden">
            </div>
        </div>

        <!-- Type Dropdown/Input -->
        <div class="form-group">
            <label>Type</label>
            <select id="editNodeType">
                <option value="">Select type</option>
                <option value="room">Room</option>
                <option value="barrier">Barrier</option>
                <option value="infrastructure">Infrastructure</option>
            </select>
        </div>

        <!-- Related Infrastructure -->
        <div class="form-group">
            <label>Related Infrastructure</label>
            <select id="editRelatedInfra">
                <option value="">Select infrastructure</option>
            </select>
        </div>

        <!-- Related Room -->
        <div class="form-group">
            <label>Related Room</label>
            <select id="editRelatedRoom">
                <option value="">Select room</option>
            </select>
        </div>

        <!-- Coordinates -->
        <div class="form-group">
            <label>Coordinates</label>
            <div class="form-row">
                <div class="form-group">
                    <input id="editLatitude" name="latitude" type="text" placeholder="Latitude">
                </div>
                <div class="form-group">
                    <input id="editLongitude" name="longitude" type="text" placeholder="Longitude">
                </div>
            </div>
        </div>

        <!-- Indoor/Outdoor -->
        <div class="form-group checkbox-row">
            <label>Indoor</label>
            <input type="checkbox" id="editIndoorCheckbox">
            <label style="margin-left:20px;">Outdoor</label>
            <input type="checkbox" id="editOutdoorCheckbox">
        </div>

        <!-- Indoor Details (hidden by default, shown if Indoor checked) -->
        <div id="editIndoorDetails" style="display:none;">
            <div class="form-group">
                <label>Floor</label>
                <input id="editFloor" type="text" placeholder="e.g. 2">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>X Coordinate</label>
                    <input id="editXCoord" type="text" placeholder="X">
                </div>
                <div class="form-group">
                    <label>Y Coordinate</label>
                    <input id="editYCoord" type="text" placeholder="Y">
                </div>
            </div>
        </div>

        <!-- Campus Dropdown -->
        <div class="form-group">
            <label>Campus</label>
            <select id="editCampusDropdown">
                <option value="">Select campus</option>
            </select>
        </div>

        <!-- Actions -->
        <div class="modal-actions">
            <button type="submit" class="save-btn">Update</button>
            <button type="button" class="cancel-btn" id="cancelEditNodeBtn">Cancel</button>
        </div>
    </form>
  </div>
</div>



<!-- Edit Edge Modal Overlay -->
<div id="editEdgeModal" class="modal-overlay" style="display:none;">
    <div class="modal">
        <h2>Edit Edge</h2>

        <form>
            <!-- Edge ID -->
            <div class="form-group"> 
                <label>Edge ID</label> 
                <input type="text" id="editEdgeId" disabled> 
            </div>

            <!-- Start & End Node -->
            <div class="form-row">
                <div class="form-group">
                    <label>Start Node</label>
                    <select id="editStartNode">
                        <option value="">Select start node</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>End Node</label>
                    <select id="editEndNode">
                        <option value="">Select end node</option>
                    </select>
                </div>
            </div>

            <!-- Additional Information -->
            <h3>Additional Information:</h3>
            <div class="form-group checkbox-row">
                <label>Bidirectional Path</label>
                <input type="checkbox" id="editBidirectional">
            </div>

            <!-- Path Type & Elevation -->
            <div class="form-row">
                <div class="form-group">
                    <label>Path Type</label>
                    <select id="editPathType">
                        <option value="">Select path type</option>
                        <option value="via_gate">Via Gate</option>
                        <option value="via_overpass">Via Overpass</option>
                        <option value="walkway">Walkway</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Elevation</label>
                    <select id="editElevation">
                        <option value="">Select elevation</option>
                        <option value="flat">Flat</option>
                        <option value="slope_up">Slope (Up)</option>
                        <option value="slope_down">Slope (Down)</option>
                        <option value="stairs">Stairs</option>
                        <option value="steep_up">Steep (Up)</option>
                        <option value="steep_down">Steep (Down)</option>
                        <option value="mixed">Mixed</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->  
            <div class="modal-actions">  
                <button type="submit" class="save-btn">Save</button>  
                <button type="button" class="cancel-btn" id="cancelEditEdgeBtn">Cancel</button>  
            </div>  
        </form>  
    </div>  
</div>







<!-- ================== SCRIPT ================== --> 
<script type="module" src="/js/map_editor.js"> 

</script>


<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
  // ======================= FIREBASE SETUP ===========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { firebaseConfig } from "./../firebaseConfig.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function loadMap() {
    try {
      // ---- Fetch lookup data first ----
      const [infraSnap, roomSnap, campusSnap] = await Promise.all([
        getDocs(collection(db, "Infrastructure")),
        getDocs(collection(db, "Rooms")),
        getDocs(collection(db, "Campus"))
      ]);

      const infraMap = {};
      infraSnap.forEach(doc => infraMap[doc.data().infra_id] = doc.data().name);

      const roomMap = {};
      roomSnap.forEach(doc => roomMap[doc.data().room_id] = doc.data().name);

      const campusMap = {};
      campusSnap.forEach(doc => campusMap[doc.data().campus_id] = doc.data().campus_name);

      // ---- Fetch Nodes ----
      const q = query(collection(db, "Nodes"), orderBy("created_at", "asc"));
      const querySnapshot = await getDocs(q);

      const nodes = [];
      querySnapshot.forEach(docSnap => {
        const d = docSnap.data();
        nodes.push({
          ...d,
          infraName: d.related_infra_id ? (infraMap[d.related_infra_id] || d.related_infra_id) : "-",
          roomName: d.related_room_id ? (roomMap[d.related_room_id] || d.related_room_id) : "-",
          campusName: d.campus_id ? (campusMap[d.campus_id] || d.campus_id) : "-"
        });
      });

      // ---- Small fixed overview map ----
      const map = L.map("map-overview", {
        center: [6.9130, 122.0630],
        zoom: 18,
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      renderDataOnMap(map, nodes);

      // ---- Modal logic ----
      const modal = document.getElementById("mapModal");
      const closeBtn = document.querySelector(".close-btn");

      document.getElementById("map-overview").addEventListener("click", () => {
        modal.style.display = "block";

        setTimeout(() => {
          const mapFull = L.map("map-full", {
            center: [6.9130, 122.0630],
            zoom: 18,
            zoomControl: true,
            dragging: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            boxZoom: true,
            keyboard: true
          });

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap"
          }).addTo(mapFull);

          renderDataOnMap(mapFull, nodes, true); // enable sidebar details
        }, 200);
      });

      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });

    } catch (err) {
      console.error("Error loading map data:", err);
    }
  }

// ---- Sidebar details ----
function showDetails(node) {
  const sidebar = document.querySelector(".map-sidebar");

  // Format created_at nicely
  let createdAtFormatted = "-";
  if (node.created_at) {
    if (typeof node.created_at.toDate === "function") {
      const d = node.created_at.toDate();
      createdAtFormatted = d.toLocaleString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    } else {
      createdAtFormatted = node.created_at;
    }
  }

  sidebar.innerHTML = `
    <div class="header-row"><h2>📌 Node Details</h2> <button class="edit-btn">Edit</button></div>
    <div class="details-item"><span>Node ID:</span> ${node.node_id || "-"}</div>
    <div class="details-item"><span>Name:</span> ${node.name || "-"}</div>
    <div class="details-item"><span>Type:</span> ${node.type || "-"}</div>
    <div class="details-item"><span>Latitude:</span> ${node.lat || "-"}</div>
    <div class="details-item"><span>Longitude:</span> ${node.lng || "-"}</div>
    <div class="details-item"><span>Infrastructure:</span> ${node.infraName || "-"}</div>
    <div class="details-item"><span>Room:</span> ${node.roomName || "-"}</div>
    ${
      node.indoor
        ? `
      <h3>🏢 Indoor Info</h3>
      <div class="details-subitem"><span>Floor:</span> ${node.indoor.floor}</div>
      <div class="details-subitem"><span>X:</span> ${node.indoor.x}</div>
      <div class="details-subitem"><span>Y:</span> ${node.indoor.y}</div>
    `
        : ""
    }
    <div class="details-item"><span>Active:</span> ${node.is_active ? "✅ Yes" : "❌ No"}</div>
    <div class="details-item"><span>Campus:</span> ${node.campusName || "-"}</div>
    <div class="details-item"><span>Created At:</span> ${createdAtFormatted}</div>
  `;
}


function renderDataOnMap(map, data, enableClick = false) {
  // --- Barriers (polygon + corner markers) ---
  const barrierNodes = data.filter(d => d.type === "barrier");
  const barrierCoords = barrierNodes.map(b => [b.lat, b.lng]);

  if (barrierCoords.length > 0) {
    // Draw polygon
    const polygon = L.polygon(barrierCoords, {
      color: "green",
      weight: 3,
      fillOpacity: 0.1
    }).addTo(map);

    if (enableClick) {
      // Click inside polygon → show campus info + clicked lat/lng
      polygon.on("click", (e) => {
        showDetails({
          name: "WMSU Camp B",
          type: "Campus Area",
          lat: e.latlng.lat.toFixed(6),
          lng: e.latlng.lng.toFixed(6)
        });
      });

      // Add markers for each barrier corner
      barrierNodes.forEach(node => {
        const cornerMarker = L.circleMarker([node.lat, node.lng], {
          radius: 6,
          color: "darkgreen",
          fillColor: "lightgreen",
          fillOpacity: 0.9
        }).addTo(map);

        cornerMarker.on("click", () => showDetails(node));
      });
    }
  }

  // --- Infrastructure (Buildings) ---
  data.filter(d => d.type === "infrastructure").forEach(building => {
    const marker = L.circleMarker([building.lat, building.lng], {
      radius: 8,
      color: "blue",
      fillColor: "lightblue",
      fillOpacity: 0.7
    }).addTo(map);

    if (enableClick) {
      marker.on("click", () => showDetails(building));
    }
  });

  // --- Rooms ---
  data.filter(d => d.type === "room").forEach(room => {
    const marker = L.marker([room.lat, room.lng]).addTo(map);

    if (enableClick) {
      marker.on("click", () => showDetails(room));
    }
  });

  // --- Fit bounds to all nodes ---
  const allCoords = data.map(d => [d.lat, d.lng]);
  if (allCoords.length > 0) {
    map.fitBounds(allCoords);
  }
}

  document.addEventListener("DOMContentLoaded", loadMap);
</script>



</body>
</html>
