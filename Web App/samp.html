<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Migrate Node Coordinates</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import { firebaseConfig } from "/firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üü¢ Reference node (0,0)
    const origin = {
      node_id: "ND-045",
      lat: 6.91463,
      lon: 122.11927,
    };

    // üü¢ Target nodes to migrate
    const targetNodeIds = ["ND-046", "ND-047", "ND-048", "ND-127", "ND-128"];

    // üßÆ Convert latitude/longitude to x,y (meters)
    function latLonToXY(lat, lon, originLat, originLon) {
      const dx =
        (lon - originLon) * Math.cos((originLat * Math.PI) / 180) * 111320;
      const dy = (lat - originLat) * 110540;
      return { x: dx, y: dy };
    }

    async function migrateNodes() {
      const btn = document.getElementById("migrateBtn");
      btn.disabled = true;
      btn.innerHTML = "Migrating... ‚è≥";

      try {
        const mapVersionsSnap = await getDocs(collection(db, "MapVersions"));
        for (const mapDoc of mapVersionsSnap.docs) {
          const mapData = mapDoc.data();
          const currentCampus = mapData.current_active_campus;
          const currentVersion = mapData.current_version;
          if (!currentCampus || !currentVersion) continue;

          const versionRef = doc(
            db,
            "MapVersions",
            mapDoc.id,
            "versions",
            currentVersion
          );
          const versionSnap = await getDoc(versionRef);
          if (!versionSnap.exists()) continue;

          const versionData = versionSnap.data();
          const nodes = Array.isArray(versionData.nodes)
            ? versionData.nodes
            : [];

          let updated = false;

          const updatedNodes = nodes.map((node) => {
            if (
              node.campus_id === currentCampus &&
              targetNodeIds.includes(node.node_id)
            ) {
              const { x, y } = latLonToXY(
                node.latitude,
                node.longitude,
                origin.lat,
                origin.lon
              );
              console.log(
                `üß≠ ${node.name} (${node.node_id}) ‚Üí x=${x.toFixed(
                  4
                )}, y=${y.toFixed(4)}`
              );
              node.x_coordinate = x;
              node.y_coordinate = y;
              updated = true;
            }
            return node;
          });

          if (updated) {
            await updateDoc(versionRef, { nodes: updatedNodes });
            console.log(`‚úÖ Updated nodes in version ${currentVersion}`);
          }
        }

        alert("üéØ Migration complete! Coordinates updated.");
      } catch (err) {
        console.error("‚ùå Migration failed:", err);
        alert("Migration failed. Check console for details.");
      } finally {
        btn.disabled = false;
        btn.innerHTML = "Migrate Coordinates";
      }
    }

    window.migrateNodes = migrateNodes;
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f8f9fa;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover:not(:disabled) {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>üó∫Ô∏è Node Coordinate Migration</h2>
  <p>This will update the x and y coordinates of 5 nodes using Bahay Ni Aldrin Main Door as (0,0).</p>
  <button id="migrateBtn" onclick="migrateNodes()">Migrate Coordinates</button>
</body>
</html>
