<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fix Node Types (Outdoor ‚Üí Infrastructure)</title>
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collectionGroup, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

 import { firebaseConfig } from "../firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function migrateOutdoorToInfra() {
      const logs = document.getElementById("logs");
      logs.textContent = "Starting migration...\n";

      try {
        // üîπ Search all versions subcollections under MapVersions
        const querySnap = await getDocs(collectionGroup(db, "versions"));

        let updatedCount = 0;

        for (const versionDoc of querySnap.docs) {
          const versionRef = versionDoc.ref;
          const versionData = versionDoc.data();

          if (!Array.isArray(versionData.nodes)) continue;

          let modified = false;
          const updatedNodes = versionData.nodes.map(node => {
            if (node.type === "outdoor") {
              node.type = "infrastructure";
              modified = true;
              updatedCount++;
              logs.textContent += `‚úîÔ∏è Updated ${node.node_id} (${node.name})\n`;
            }
            return node;
          });

          if (modified) {
            await updateDoc(versionRef, { nodes: updatedNodes });
          }
        }

        logs.textContent += `\n‚úÖ Migration complete. ${updatedCount} nodes updated.`;

      } catch (err) {
        logs.textContent += `\n‚ùå Error: ${err.message}`;
        console.error(err);
      }
    }

    window.runMigration = migrateOutdoorToInfra;
  </script>
</head>
<body style="font-family: Arial; padding: 20px;">
  <h2>Fix Node Types: Outdoor ‚Üí Infrastructure</h2>
  <p>Click below to run the migration. It will scan all map versions and update nodes with <b>type: "outdoor"</b> to <b>"infrastructure"</b>.</p>
  <button onclick="runMigration()" style="padding: 10px 20px; font-size: 16px;">Run Migration</button>
  <pre id="logs" style="margin-top: 20px; background: #111; color: #0f0; padding: 10px; height: 400px; overflow-y: scroll;"></pre>
</body>
</html>
