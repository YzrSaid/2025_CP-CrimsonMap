<!DOCTYPE html>
<html>
<head>
  <title>Firestore Migration - Remove Wrong Coordinate Fields</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // TODO: Replace with your Firebase config
 import { firebaseConfig } from "../firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function migrate() {
      const mapVersionsRef = collection(db, "MapVersions");
      const mapVersionsSnap = await getDocs(mapVersionsRef);

      for (const mapDoc of mapVersionsSnap.docs) {
        const mapDocId = mapDoc.id;
        console.log(`Processing Map: ${mapDocId}`);

        const versionsRef = collection(db, "MapVersions", mapDocId, "versions");
        const versionsSnap = await getDocs(versionsRef);

        for (const versionDoc of versionsSnap.docs) {
          const versionId = versionDoc.id;
          const versionData = versionDoc.data();

          let updated = false;
          let nodes = versionData.nodes || [];

          let cleanedNodes = nodes.map((node) => {
            let newNode = { ...node };

            if ("x_coordinates" in newNode) {
              delete newNode.x_coordinates;
              updated = true;
            }
            if ("y_coordinates" in newNode) {
              delete newNode.y_coordinates;
              updated = true;
            }

            return newNode;
          });

          if (updated) {
            console.log(`Removing wrong fields in version ${versionId} of map ${mapDocId}`);
            await updateDoc(doc(db, "MapVersions", mapDocId, "versions", versionId), {
              nodes: cleanedNodes
            });
          }
        }
      }

      alert("Migration completed: deleted x_coordinates and y_coordinates!");
    }

    window.runMigration = migrate;
  </script>
</head>
<body>
  <h1>Firestore Migration Tool - Remove Wrong Coordinate Fields</h1>
  <button onclick="runMigration()">Run Migration</button>
  <p>Check console for logs.</p>
</body>
</html>
