<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Migrate Nodes & Edges</title>
</head>
<body>
    <h2>MapVersions Nodes & Edges Migration</h2>
    <button id="migrateBtn">Migrate Nodes & Edges</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        import { firebaseConfig } from "./firebaseConfig.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const migrateBtn = document.getElementById("migrateBtn");

        migrateBtn.addEventListener("click", async () => {
            migrateBtn.disabled = true;
            migrateBtn.textContent = "Migrating...";

            try {
                // 1️⃣ Fetch all Nodes
                const nodesSnap = await getDocs(collection(db, "Nodes"));
                const nodesData = nodesSnap.docs.map(d => {
                    const data = d.data();
                    // Keep all fields, just ignore Firestore doc id
                    return { ...data };
                });

                // 2️⃣ Fetch all Edges
                const edgesSnap = await getDocs(collection(db, "Edges"));
                const edgesData = edgesSnap.docs.map(d => {
                    const data = d.data();
                    // Keep all fields, just ignore Firestore doc id
                    return { ...data };
                });

                console.log("Fetched Nodes:", nodesData);
                console.log("Fetched Edges:", edgesData);

                // 3️⃣ Fetch all MapVersions
                const mapVersionsSnap = await getDocs(collection(db, "MapVersions"));

                for (const mapDoc of mapVersionsSnap.docs) {
                    const mapData = mapDoc.data();
                    console.log("Migrating MapVersion:", mapData.map_name || mapDoc.id);

                    // 4️⃣ Fetch all documents in versions subcollection
                    const versionsSnap = await getDocs(collection(db, `MapVersions/${mapDoc.id}/versions`));

                    for (const versionDoc of versionsSnap.docs) {
                        // Update nodes & edges inside the version document
                        await updateDoc(doc(db, `MapVersions/${mapDoc.id}/versions/${versionDoc.id}`), {
                            nodes: nodesData,
                            edges: edgesData
                        });

                        console.log(`Migrated version ${versionDoc.id}`);
                    }
                }

                alert("Migration completed successfully!");
            } catch (err) {
                console.error("Error migrating Nodes & Edges:", err);
                alert("Migration failed. Check console for details.");
            } finally {
                migrateBtn.disabled = false;
                migrateBtn.textContent = "Migrate Nodes & Edges";
            }
        });
    </script>
</body>
</html>
