<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leaflet + Firebase Map</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // ======================= FIREBASE SETUP ===========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { firebaseConfig } from "firebaseConfig.js"; // <-- make sure this file exists

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadMap() {
      try {
        // Fetch nodes from Firestore
        const q = query(collection(db, "Nodes"), orderBy("created_at", "asc"));
        const querySnapshot = await getDocs(q);

        const nodes = [];
        querySnapshot.forEach(docSnap => {
          nodes.push(docSnap.data());
        });

        // Create the map
        const map = L.map("map", {
          center: [6.9130, 122.0630],
          zoom: 17,
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);

        // Separate data types
        const barrierNodes = nodes.filter(d => d.type === "barrier");
        const buildingNodes = nodes.filter(d => d.type === "infrastructure");
        const roomNodes = nodes.filter(d => d.type === "room");

        // --- Draw barrier polygon ---
        if (barrierNodes.length > 0) {
          const barrierCoords = barrierNodes.map(b => [b.latitude, b.longitude]);
          const barrier = L.polygon(barrierCoords, {
            color: "green",
            weight: 3,
            fillOpacity: 0.2,
          }).addTo(map);
          barrier.bindPopup("<b>Barrier</b><br>Campus boundary");

          // Add corner markers
          barrierNodes.forEach(node => {
            const cornerMarker = L.circleMarker([node.latitude, node.longitude], {
              radius: 5,
              color: "darkgreen",
              fillColor: "lightgreen",
              fillOpacity: 0.9,
            }).addTo(map);
            cornerMarker.bindPopup(`<b>Barrier Corner</b><br>${node.name || "-"}`);
          });
        }

        // --- Draw buildings ---
        buildingNodes.forEach(building => {
          const marker = L.circleMarker([building.latitude, building.longitude], {
            radius: 8,
            color: "blue",
            fillColor: "lightblue",
            fillOpacity: 0.7,
          }).addTo(map);
          marker.bindPopup(`<b>${building.name || "Building"}</b><br>Type: Infrastructure`);
        });

        // --- Draw rooms ---
        roomNodes.forEach(room => {
          const marker = L.marker([room.latitude, room.longitude]).addTo(map);
          marker.bindPopup(`<b>${room.name || "Room"}</b><br>Type: Room`);
        });

        // --- Fit map to all nodes ---
        const allCoords = nodes.map(d => [d.latitude, d.longitude]);
        if (allCoords.length > 0) {
          map.fitBounds(allCoords);
        }

      } catch (err) {
        console.error("Error loading map data:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", loadMap);
  </script>
</body>
</html>
